<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🌍 Urban Health Visualization - NASA GIBS Data Explorer</title>
  <meta name="description" content="Interactive map visualization showing urban health data, pollution, population density, and environmental factors using NASA GIBS satellite data">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #map { height: 100vh; width: 100%; }
    .legend {
      position: absolute; bottom: 20px; left: 20px;
      background: rgba(0,0,0,0.8); color: white;
      padding: 15px 20px; border-radius: 10px;
      font-family: sans-serif; font-size: 14px;
      line-height: 1.6; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .controls {
      position:absolute; top:10px; right:10px; z-index:1200;
      background:rgba(255,255,255,0.95); padding:15px; border-radius:8px;
      font-family: Arial, sans-serif; font-size:14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    #citySelector {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1300;
      padding: 8px 15px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid #007bff;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-weight: 500;
    }
    .header {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1300;
      background: rgba(255,255,255,0.95);
      padding: 10px 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .header h1 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }
    .header p {
      margin: 5px 0 0 0;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
<div class="header">
  <h1>🌍 Urban Health & Environment Monitor</h1>
  <p>NASA GIBS Satellite Data • Real-time Environmental Analysis</p>
</div>

<div id="map"></div>

<select id="citySelector">
  <option value="" selected>-- Select a city to explore --</option>
  <option value="Cotonou">🇧🇯 Cotonou, Benin</option>
  <option value="Abidjan">🇨🇮 Abidjan, Côte d'Ivoire</option>
  <option value="Paris">🇫🇷 Paris, France</option>
  <option value="Lagos">🇳🇬 Lagos, Nigeria</option>
  <option value="Accra">🇬🇭 Accra, Ghana</option>
</select>

<div id="eventPanel" style="
    position: absolute;
    top: 120px;
    left: 10px;
    z-index: 1200;
    background: rgba(255,255,255,0.95);
    max-height: 400px;
    width: 280px;
    overflow-y: auto;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    font-family: Arial, sans-serif;
">
  <h4 style="margin-top: 0; color: #333;">🔔 Latest Environmental Events</h4>
  <ul id="eventList" style="list-style:none; padding:0; margin:0;"></ul>
</div>

<div class="legend" id="legend">
  <b>📊 Data Layers Legend</b><br>
  🔴 <strong>Aerosol/Pollution</strong> - Air quality indicators<br>
  🟢 <strong>Population Density</strong> - Urban concentration<br>
  🔥 <strong>Active Fires</strong> - Real-time fire detection<br>
  🌿 <strong>Vegetation Index</strong> - Green cover analysis<br>
  🌡️ <strong>Surface Temperature</strong> - Heat island effects<br>
  🏥 <strong>Health Facilities</strong> - Medical infrastructure<br>
  ⚫ <strong>Geographic References</strong> - Borders & coastlines
</div>

<script>
/* --------- Map initialization --------- */
const map = L.map('map', {
  center: [14.7, -17.4], // Default: West Africa region
  zoom: 5,
  crs: L.CRS.EPSG4326
});

const d = new Date(); d.setDate(d.getDate() - 1);
const dateValue = () => d.toISOString().split('T')[0];

const gibsWMS = "https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi";

/* --------- Panes for z-index management --------- */
map.createPane('basePane'); map.getPane('basePane').style.zIndex = 200;
map.createPane('overlayPane'); map.getPane('overlayPane').style.zIndex = 300;
map.createPane('labelPane'); map.getPane('labelPane').style.zIndex = 650;
map.getPane('labelPane').style.pointerEvents = 'none';

/* --------- Base satellite layers --------- */
const baseLayers = {
  "🛰️ MODIS Terra (True Color)": L.tileLayer.wms(gibsWMS, {
    layers: "MODIS_Terra_CorrectedReflectance_TrueColor",
    format: "image/jpeg",
    time: dateValue(),
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS"
  }),
  "🛰️ MODIS Aqua (True Color)": L.tileLayer.wms(gibsWMS, {
    layers: "MODIS_Aqua_CorrectedReflectance_TrueColor",
    format: "image/jpeg",
    time: dateValue(),
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS"
  }),
  "🛰️ VIIRS Suomi NPP": L.tileLayer.wms(gibsWMS, {
    layers: "VIIRS_SNPP_CorrectedReflectance_TrueColor",
    format: "image/jpeg",
    time: dateValue(),
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS"
  }),
  "🌍 Blue Marble": L.tileLayer.wms(gibsWMS, {
    layers: "BlueMarble_ShadedRelief_Bathymetry",
    format: "image/jpeg",
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS / Blue Marble"
  })
};

baseLayers["🌍 Blue Marble"].addTo(map);

/* --------- Utility function for overlay creation --------- */
function createOverlayWMS(layerName, opts = {}) {
  return L.tileLayer.wms(gibsWMS, Object.assign({
    layers: layerName,
    format: 'image/png',
    transparent: true,
    tileSize: 512,
    pane: 'overlayPane',
    attribution: 'NASA GIBS'
  }, opts));
}

/* --------- Environmental data overlays --------- */
let aerosolLayer = createOverlayWMS("MODIS_Terra_Aerosol", {opacity: 0.7, time: dateValue()});
let populationLayer = createOverlayWMS("GPW_Population_Density_2020", {opacity: 0.6});
let firesLayer = createOverlayWMS("MODIS_Terra_Fires", {opacity:0.8, time: dateValue()});
let vegetationLayer = createOverlayWMS("MODIS_Terra_CorrectedReflectance_Bands721", {opacity:0.7, time: dateValue()});
let temperatureLayer = createOverlayWMS("MODIS_Terra_Land_Surface_Temp_Day", {opacity:0.7, time: dateValue()});

/* --------- Reference layers --------- */
let featuresLayer = createOverlayWMS("Reference_Features", {opacity:0.9});
let coastlinesLayer = createOverlayWMS("Coastlines", {opacity:1.0});
let labelsLayer = createOverlayWMS("Reference_Labels", {pane: 'labelPane'});

/* --------- Health facilities markers --------- */
const healthGroup = L.layerGroup([], {pane:'overlayPane'});

/* --------- Dynamic city data overlay --------- */
const osmOverlayGroup = L.layerGroup([], {pane:'overlayPane'});

const cityCoords = {
  "Cotonou": [6.3703, 2.3912],
  "Abidjan": [5.3453, -4.0244],
  "Paris": [48.8566, 2.3522],
  "Lagos": [6.5244, 3.3792],
  "Accra": [5.6037, -0.1870]
};

async function loadOSMCity(city, lat, lon){
  osmOverlayGroup.clearLayers();
  const delta = 0.15;
  const bbox = [lat-delta, lon-delta, lat+delta, lon+delta].join(',');
  
  try {
    // Load cities and towns
    const queryCities = `[out:json][timeout:25]; node["place"~"city|town"](${bbox}); out body; >; out skel qt;`;
    const urlCities = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(queryCities);
    const respCities = await fetch(urlCities);
    const dataCities = await respCities.json();
    
    dataCities.elements.forEach(node => {
      const name = node.tags.name || "Unknown";
      const population = node.tags.population ? parseInt(node.tags.population) : 0;
      const radius = population ? Math.max(4, Math.sqrt(population)/100) : 4;
      const marker = L.circleMarker([node.lat, node.lon], {
        radius: radius,
        color: '#ff7800',
        fillColor: '#ff7800',
        fillOpacity: 0.7,
        weight: 2
      }).bindPopup(`<b>🏙️ ${name}</b><br>Population: ${population.toLocaleString()}<br>Type: ${node.tags.place || 'City'}`);
      osmOverlayGroup.addLayer(marker);
    });
    
    // Load health facilities
    const queryHealth = `[out:json][timeout:25]; node["amenity"~"hospital|clinic"](${bbox}); out body; >; out skel qt;`;
    const urlHealth = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(queryHealth);
    const respHealth = await fetch(urlHealth);
    const dataHealth = await respHealth.json();
    
    dataHealth.elements.forEach(node => {
      const name = node.tags.name || "Health Facility";
      const amenity = node.tags.amenity || "medical";
      const marker = L.circleMarker([node.lat, node.lon], {
        radius: 8,
        color: '#28a745',
        fillColor: '#28a745',
        fillOpacity: 0.9,
        weight: 2
      }).bindPopup(`<b>🏥 ${name}</b><br>Type: ${amenity}<br>Operator: ${node.tags.operator || 'N/A'}`);
      osmOverlayGroup.addLayer(marker);
    });
  } catch(error) {
    console.error('Error loading OSM data:', error);
  }
}

/* --------- Layer control panel --------- */
const overlays = {
  "🔴 Air Quality (Aerosol)": aerosolLayer,
  "🟢 Population Density": populationLayer,
  "🔥 Active Fires": firesLayer,
  "🌿 Vegetation Index": vegetationLayer,
  "🌡️ Surface Temperature": temperatureLayer,
  "🏥 Health Infrastructure": healthGroup,
  "🛣️ Geographic Features": featuresLayer,
  "🌊 Coastlines": coastlinesLayer,
  "🏷️ Place Labels": labelsLayer,
  "🌐 City Data (OSM)": osmOverlayGroup
};

L.control.layers(baseLayers, overlays, {collapsed: false}).addTo(map);

/* --------- NASA EONET Events (Environmental disasters) --------- */
const eventsGroup = L.layerGroup().addTo(map);

async function loadEvents() {
  try {
    const resp = await fetch("https://eonet.gsfc.nasa.gov/api/v3/events?status=open&limit=30");
    const data = await resp.json();
    const ul = document.getElementById("eventList");
    ul.innerHTML = "";
    
    data.events.forEach(ev => {
      const geom = ev.geometry?.[0];
      if(!geom) return;
      
      const coords = geom.coordinates;
      let icon = "🌍";
      let color = "#007bff";
      
      ev.categories.forEach(cat => {
        const c = cat.title.toLowerCase();
        if(c.includes("wildfire")) { icon="🔥"; color="#dc3545"; }
        if(c.includes("storm")||c.includes("cyclone")||c.includes("hurricane")) { icon="🌪️"; color="#6f42c1"; }
        if(c.includes("volcano")) { icon="🌋"; color="#fd7e14"; }
        if(c.includes("flood")) { icon="💧"; color="#0dcaf0"; }
        if(c.includes("drought")) { icon="🏜️"; color="#ffc107"; }
      });
      
      const li = document.createElement("li");
      li.style.cursor = "pointer";
      li.style.padding = "8px 0";
      li.style.borderBottom = "1px solid #eee";
      li.innerHTML = `<div style="color: ${color};">${icon} <strong>${ev.title}</strong></div><small style="color: #666;">${geom.date}</small>`;
      
      li.addEventListener("click", () => {
        map.setView([coords[1], coords[0]], 8);
        eventsGroup.clearLayers();
        
        const marker = L.marker([coords[1], coords[0]], {
          icon: L.divIcon({
            className: "event-icon",
            html: `<div style="font-size:30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">${icon}</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
          })
        }).bindPopup(`<b>${ev.title}</b><br><small>${geom.date}</small><br><a href="${ev.sources?.[0]?.url||'#'}" target="_blank">🔗 More info</a>`);
        
        eventsGroup.addLayer(marker);
        marker.openPopup();
      });
      
      ul.appendChild(li);
    });
  } catch(err) {
    console.error('Error loading events:', err);
    document.getElementById("eventList").innerHTML = '<li style="color: #dc3545;">⚠️ Unable to load events</li>';
  }
}

loadEvents();

/* --------- City selector functionality --------- */
document.getElementById("citySelector").addEventListener("change", function(){
  const city = this.value;
  if(cityCoords[city]){
    const [lat, lon] = cityCoords[city];
    map.setView([lat, lon], 12);
    loadOSMCity(city, lat, lon);
    
    // Add a marker for the selected city
    const cityMarker = L.marker([lat, lon], {
      icon: L.divIcon({
        className: "city-marker",
        html: '<div style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;">📍 ' + city + '</div>',
        iconSize: [100, 30],
        iconAnchor: [50, 15]
      })
    });
    osmOverlayGroup.addLayer(cityMarker);
  } else {
    osmOverlayGroup.clearLayers();
  }
});

/* --------- Add default layers --------- */
coastlinesLayer.addTo(map);
labelsLayer.addTo(map);

console.log("🌍 Urban Health Visualization loaded successfully!");
</script>
</body>
</html>
