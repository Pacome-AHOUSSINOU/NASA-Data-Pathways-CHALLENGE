<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üåç GIBS Visualization - With Place Labels and Dynamic Cities</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100vh; width: 100%; }
    .legend {
      position: absolute; bottom: 20px; left: 20px;
      background: rgba(0,0,0,0.6); color: white;
      padding: 10px 15px; border-radius: 8px;
      font-family: sans-serif; font-size: 13px;
      line-height: 1.5;
    }
    .controls {
      position:absolute; top:10px; right:10px; z-index:1200;
      background:rgba(255,255,255,0.95); padding:10px; border-radius:6px;
      font-family: Arial, sans-serif; font-size:13px;
    }
    #citySelector {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1300;
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: white;
    }
  </style>
</head>
<body>
<div id="map"></div>

<select id="citySelector">
  <option value="" selected>-- Select a city --</option>
  <option value="Cotonou">Cotonou</option>
  <option value="Abidjan">Abidjan</option>
  <option value="Paris">Paris</option>
</select>

<div id="eventPanel" style="
    position: absolute;
    top: 50px;
    left: 10px;
    z-index: 1200;
    background: rgba(255,255,255,0.95);
    max-height: 400px;
    width: 250px;
    overflow-y: auto;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    font-family: Arial, sans-serif;
">
  <h4>üîî Latest Events</h4>
  <ul id="eventList" style="list-style:none; padding:0; margin:0;"></ul>
</div>

<div class="legend" id="legend">
  <b>üìä Legend</b><br>
  üî¥ Aerosol / Pollution (GIBS)<br>
  üü¢ Population / Health (GPW)<br>
  üåø Vegetation / Land areas<br>
  ‚ö´ Map references: labels, borders, coastlines
</div>

<script>
/* --------- Map initialization --------- */
const map = L.map('map', {
  center: [14.7, -17.4], // Default: Dakar
  zoom: 5,
  crs: L.CRS.EPSG4326
});

const d = new Date(); d.setDate(d.getDate() - 1);
const dateValue = () => document.getElementById('dateInput')?.value || d.toISOString().split('T')[0];

const gibsWMS = "https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi";

/* --------- Panes for z-index --------- */
map.createPane('basePane'); map.getPane('basePane').style.zIndex = 200;
map.createPane('overlayPane'); map.getPane('overlayPane').style.zIndex = 300;
map.createPane('labelPane'); map.getPane('labelPane').style.zIndex = 650;
map.getPane('labelPane').style.pointerEvents = 'none';

/* --------- Base layers --------- */
const baseLayers = {
  "MODIS Terra (True Color)": L.tileLayer.wms(gibsWMS, {
    layers: "MODIS_Terra_CorrectedReflectance_TrueColor",
    format: "image/jpeg",
    time: dateValue(),
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS"
  }),
  "MODIS Aqua (True Color)": L.tileLayer.wms(gibsWMS, {
    layers: "MODIS_Aqua_CorrectedReflectance_TrueColor",
    format: "image/jpeg",
    time: dateValue(),
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS"
  }),
  "VIIRS Suomi NPP (True Color)": L.tileLayer.wms(gibsWMS, {
    layers: "VIIRS_SNPP_CorrectedReflectance_TrueColor",
    format: "image/jpeg",
    time: dateValue(),
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS"
  }),
  "Blue Marble (2004)": L.tileLayer.wms(gibsWMS, {
    layers: "BlueMarble_ShadedRelief_Bathymetry",
    format: "image/jpeg",
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS / Blue Marble"
  })
};

baseLayers["Blue Marble (2004)"].addTo(map);

/* --------- Utility function for overlays --------- */
function createOverlayWMS(layerName, opts = {}) {
  return L.tileLayer.wms(gibsWMS, Object.assign({
    layers: layerName,
    format: 'image/png',
    transparent: true,
    tileSize: 512,
    pane: 'overlayPane',
    attribution: 'NASA GIBS'
  }, opts));
}

/* --------- Main overlays --------- */
let aerosolLayer = createOverlayWMS("MODIS_Terra_Aerosol", {opacity: 0.65, time: dateValue()});
let populationLayer = createOverlayWMS("GPW_Population_Density_2020", {opacity: 0.5});
let firesLayer = createOverlayWMS("MODIS_Terra_Fires", {opacity:0.7, time: dateValue()});
let vegetationLayer = createOverlayWMS("MODIS_Terra_CorrectedReflectance_Bands721", {opacity:0.6, time: dateValue()});
let temperatureLayer = createOverlayWMS("MODIS_Terra_Land_Surface_Temp_Day", {opacity:0.6, time: dateValue()});

/* --------- Reference layers / labels --------- */
let featuresLayer = createOverlayWMS("Reference_Features", {opacity:0.85});
let coastlinesLayer = createOverlayWMS("Coastlines", {opacity:0.95});
let labelsLayer = createOverlayWMS("Reference_Labels");

/* --------- Local markers --------- */
const healthGroup = L.layerGroup([], {pane:'overlayPane'});
const marker = L.circleMarker([14.7167, -17.4677], { radius:7, color:'#28a745', fillColor:'#28a745', fillOpacity:0.9 });
marker.bindPopup("<b>Main Hospital of Dakar</b>");
healthGroup.addLayer(marker);

/* --------- Dynamic OSM overlay --------- */
const osmOverlayGroup = L.layerGroup([], {pane:'overlayPane'});

const cityCoords = {
  "Cotonou":[6.3703, 2.3912],
  "Abidjan":[5.3453, -4.0244],
  "Paris":[48.8566, 2.3522]
};

async function loadOSMCity(city, lat, lon){
  osmOverlayGroup.clearLayers();
  const delta = 0.15;
  const bbox = [lat-delta, lon-delta, lat+delta, lon+delta].join(',');
  
  // cities (place=city/town)
  const queryCities = `[out:json][timeout:25]; node["place"~"city|town"](${bbox}); out body; >; out skel qt;`;
  const urlCities = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(queryCities);
  const respCities = await fetch(urlCities);
  const dataCities = await respCities.json();
  dataCities.elements.forEach(node => {
    const name = node.tags.name || "Unknown";
    const population = node.tags.population ? parseInt(node.tags.population) : 0;
    const radius = population ? Math.sqrt(population)/100 : 4;
    const marker = L.circleMarker([node.lat, node.lon], {
      radius: radius,
      color: '#ff7800',
      fillColor: '#ff7800',
      fillOpacity: 0.6
    }).bindPopup(`<b>${name}</b><br>Population: ${population.toLocaleString()}`);
    osmOverlayGroup.addLayer(marker);
  });
  
  // health facilities
  const queryHealth = `[out:json][timeout:25]; node["amenity"~"hospital|clinic"](${bbox}); out body; >; out skel qt;`;
  const urlHealth = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(queryHealth);
  const respHealth = await fetch(urlHealth);
  const dataHealth = await respHealth.json();
  dataHealth.elements.forEach(node => {
    const name = node.tags.name || "Unknown";
    const marker = L.circleMarker([node.lat, node.lon], {
      radius: 6,
      color: '#28a745',
      fillColor: '#28a745',
      fillOpacity: 0.9
    }).bindPopup(`<b>${name}</b>`);
    osmOverlayGroup.addLayer(marker);
  });
}

/* --------- Control panel --------- */
const overlays = {
  "üü• Aerosol (MODIS AOD)": aerosolLayer,
  "üü† Population (GPW)": populationLayer,
  "üî• Active Fires (MODIS)": firesLayer,
  "üåø Vegetation (MODIS)": vegetationLayer,
  "üå°Ô∏è Surface Temperature (MODIS)": temperatureLayer,
  "üè• Health infrastructure (points)": healthGroup,
  "üõ£Ô∏è Borders / Roads": featuresLayer,
  "üåä Coastlines": coastlinesLayer,
  "üóÇÔ∏è Place Labels": labelsLayer,
  "üåê Dynamic OSM (Cities + Health)": osmOverlayGroup
};

L.control.layers(baseLayers, overlays, {collapsed:false}).addTo(map);

/* --------- EONET Events --------- */
const eventsGroup = L.layerGroup().addTo(map);
async function loadEvents() {
  try {
    const resp = await fetch("https://eonet.gsfc.nasa.gov/api/v3/events?status=open&limit=50");
    const data = await resp.json();
    const ul = document.getElementById("eventList"); ul.innerHTML = "";
    data.events.forEach(ev => {
      const geom = ev.geometry?.[0]; if(!geom) return;
      const coords = geom.coordinates; 
      let icon = "üåç";
      ev.categories.forEach(cat=>{
        const c = cat.title.toLowerCase();
        if(c.includes("wildfire")) icon="üî•";
        if(c.includes("storm")||c.includes("cyclone")||c.includes("hurricane")) icon="üå™Ô∏è";
        if(c.includes("volcano")) icon="üåã";
        if(c.includes("flood")) icon="üíß";
      });
      const li = document.createElement("li");
      li.style.cursor="pointer"; li.style.padding="4px 0";
      li.innerHTML = `${icon} ${ev.title} <br><small>${geom.date}</small>`;
      li.addEventListener("click", ()=> {
        map.setView([coords[1], coords[0]],5);
        const marker = L.marker([coords[1], coords[0]], {
          icon:L.divIcon({className:"event-icon", html:`<div style="font-size:24px;">${icon}</div>`, iconSize:[24,24], iconAnchor:[12,12]})
        }).bindPopup(`<b>${ev.title}</b><br>${geom.date}<br><a href="${ev.sources?.[0]?.url||'#'}" target="_blank">üîó Source</a>`);
        eventsGroup.addLayer(marker);
      });
      ul.appendChild(li);
    });
  } catch(err){ console.error(err); }
}
loadEvents();

/* --------- UI Checkboxes --------- */
document.getElementById('chkAerosol')?.addEventListener('change', e=>{ e.target.checked? aerosolLayer.addTo(map) : map.removeLayer(aerosolLayer); });
document.getElementById('chkPopulation')?.addEventListener('change', e=>{ e.target.checked? populationLayer.addTo(map) : map.removeLayer(populationLayer); });
document.getElementById('chkCoastlines')?.addEventListener('change', e=>{ e.target.checked? coastlinesLayer.addTo(map) : map.removeLayer(coastlinesLayer); });
document.getElementById('chkFeatures')?.addEventListener('change', e=>{ e.target.checked? featuresLayer.addTo(map) : map.removeLayer(featuresLayer); });

/* --------- Update time-dependent layers --------- */
function refreshDateLayers() {
  const t = dateValue();
  aerosolLayer.setParams({time:t});
  firesLayer.setParams({time:t});
  vegetationLayer.setParams({time:t});
}
document.getElementById('dateInput')?.addEventListener('change', refreshDateLayers);

/* --------- City selector --------- */
document.getElementById("citySelector").addEventListener("change", function(){
  const city = this.value;
  if(cityCoords[city]){
    const [lat, lon] = cityCoords[city];
    map.setView([lat, lon], 12);
    loadOSMCity(city, lat, lon);
  } else {
    osmOverlayGroup.clearLayers();
  }
});
</script>
</body>
</html>
