<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåç GIBS Earth Visualization</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html, body { 
      height: 100%; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0e27;
      color: #fff;
    }
    
    #map { 
      height: 100vh; 
      width: 100%;
      filter: contrast(1.05) brightness(0.95);
    }

    /* Header */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: linear-gradient(180deg, rgba(10,14,39,0.95) 0%, rgba(10,14,39,0.7) 100%);
      backdrop-filter: blur(20px);
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    /* City Selector */
    #citySelector {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    #citySelector:hover {
      background: rgba(255,255,255,0.15);
      border-color: rgba(255,255,255,0.3);
    }

    #citySelector option {
      background: #1a1f3a;
      color: white;
    }

    /* Side Panel */
    .side-panel {
      position: absolute;
      top: 100px;
      right: 30px;
      width: 320px;
      max-height: calc(100vh - 140px);
      background: rgba(26,31,58,0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      overflow: hidden;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .panel-header h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }

    .panel-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .panel-content::-webkit-scrollbar {
      width: 6px;
    }

    .panel-content::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
    }

    .panel-content::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
    }

    /* Layer Controls */
    .layer-group {
      margin-bottom: 25px;
    }

    .layer-group-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 12px;
    }

    .layer-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }

    .layer-item:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
    }

    .layer-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 12px;
      cursor: pointer;
    }

    .layer-item label {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    /* Events Panel */
    #eventPanel {
      position: absolute;
      bottom: 30px;
      left: 30px;
      width: 320px;
      max-height: 400px;
      background: rgba(26,31,58,0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      overflow: hidden;
      z-index: 1000;
    }

    #eventPanel h4 {
      padding: 20px;
      margin: 0;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      font-size: 16px;
      font-weight: 600;
    }

    #eventList {
      list-style: none;
      padding: 15px;
      max-height: 320px;
      overflow-y: auto;
    }

    #eventList::-webkit-scrollbar {
      width: 6px;
    }

    #eventList::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
    }

    #eventList::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
    }

    #eventList li {
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      font-size: 14px;
    }

    #eventList li:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
      transform: translateX(5px);
    }

    #eventList small {
      display: block;
      color: rgba(255,255,255,0.6);
      margin-top: 4px;
      font-size: 12px;
    }

    /* Legend */
    .legend {
      position: absolute;
      top: 100px;
      left: 30px;
      background: rgba(26,31,58,0.95);
      backdrop-filter: blur(20px);
      padding: 20px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      font-size: 13px;
      line-height: 2;
      z-index: 1000;
    }

    .legend b {
      display: block;
      font-size: 16px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Leaflet customization */
    .leaflet-control-layers {
      display: none;
    }

    .leaflet-popup-content-wrapper {
      background: rgba(26,31,58,0.98);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .leaflet-popup-tip {
      background: rgba(26,31,58,0.98);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .leaflet-popup-content {
      margin: 15px;
      font-size: 14px;
    }

    .leaflet-popup-content b {
      color: #667eea;
    }

    .leaflet-popup-content a {
      color: #667eea;
      text-decoration: none;
    }

    .leaflet-popup-content a:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .side-panel, #eventPanel, .legend {
        width: calc(100% - 40px);
        left: 20px;
        right: 20px;
      }
      
      .side-panel {
        max-height: 300px;
      }

      .header {
        flex-direction: column;
        gap: 15px;
      }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="logo">
    <span>üåç</span>
    <span>GIBS Earth Monitor</span>
  </div>
  <div class="header-controls">
    <select id="citySelector">
      <option value="" selected>Select a city</option>
      <option value="Cotonou">üáßüáØ Cotonou</option>
      <option value="Abidjan">üá®üáÆ Abidjan</option>
      <option value="Paris">üá´üá∑ Paris</option>
    </select>
  </div>
</div>

<div id="map"></div>

<div class="side-panel">
  <div class="panel-header">
    <h3>üó∫Ô∏è Map Layers</h3>
  </div>
  <div class="panel-content">
    <div class="layer-group">
      <div class="layer-group-title">Base Layers</div>
      <div class="layer-item">
        <input type="radio" name="baseLayer" id="base0" value="google_satellite" checked>
        <label for="base0">üõ∞Ô∏è Google Satellite</label>
      </div>
      <div class="layer-item">
        <input type="radio" name="baseLayer" id="base0b" value="google_hybrid">
        <label for="base0b">üó∫Ô∏è Google Hybrid</label>
      </div>
      <div class="layer-item">
        <input type="radio" name="baseLayer" id="base0c" value="google_streets">
        <label for="base0c">üöó Google Streets</label>
      </div>
      <div class="layer-item">
        <input type="radio" name="baseLayer" id="base0d" value="google_terrain">
        <label for="base0d">‚õ∞Ô∏è Google Terrain</label>
      </div>
      <div class="layer-item">
        <input type="radio" name="baseLayer" id="base1" value="modis_terra">
        <label for="base1">MODIS Terra True Color</label>
      </div>
      <div class="layer-item">
        <input type="radio" name="baseLayer" id="base2" value="modis_aqua">
        <label for="base2">MODIS Aqua True Color</label>
      </div>
      <div class="layer-item">
        <input type="radio" name="baseLayer" id="base3" value="viirs">
        <label for="base3">VIIRS Suomi NPP</label>
      </div>
      <div class="layer-item">
        <input type="radio" name="baseLayer" id="base4" value="blue_marble">
        <label for="base4">Blue Marble 2004</label>
      </div>
    </div>

    <div class="layer-group">
      <div class="layer-group-title">Overlays</div>
      <div class="layer-item">
        <input type="checkbox" id="chkAerosol">
        <label for="chkAerosol">üü• Aerosol (MODIS AOD)</label>
      </div>
      <div class="layer-item">
        <input type="checkbox" id="chkPopulation">
        <label for="chkPopulation">üü† Population Density</label>
      </div>
      <div class="layer-item">
        <input type="checkbox" id="chkFires">
        <label for="chkFires">üî• Active Fires</label>
      </div>
      <div class="layer-item">
        <input type="checkbox" id="chkVegetation">
        <label for="chkVegetation">üåø Vegetation Index</label>
      </div>
      <div class="layer-item">
        <input type="checkbox" id="chkTemperature">
        <label for="chkTemperature">üå°Ô∏è Surface Temperature</label>
      </div>
      <div class="layer-item">
        <input type="checkbox" id="chkHealth">
        <label for="chkHealth">üè• Health Infrastructure</label>
      </div>
      <div class="layer-item">
        <input type="checkbox" id="chkFeatures">
        <label for="chkFeatures">üõ£Ô∏è Borders & Roads</label>
      </div>
      <div class="layer-item">
        <input type="checkbox" id="chkCoastlines">
        <label for="chkCoastlines">üåä Coastlines</label>
      </div>
      <div class="layer-item">
        <input type="checkbox" id="chkLabels" checked>
        <label for="chkLabels">üóÇÔ∏è Place Labels</label>
      </div>
      <div class="layer-item">
        <input type="checkbox" id="chkOSM">
        <label for="chkOSM">üåê OSM Cities & Health</label>
      </div>
    </div>
  </div>
</div>

<div id="eventPanel">
  <h4>üîî Live Earth Events</h4>
  <ul id="eventList"></ul>
</div>

<div class="legend">
  <b>üìä Legend</b>
  üî¥ Aerosol / Pollution<br>
  üü¢ Population / Health<br>
  üåø Vegetation / Land<br>
  ‚ö´ References & Labels
</div>

<script>
/* Map initialization */
const map = L.map('map', {
  center: [14.7, -17.4],
  zoom: 5,
  zoomControl: true
});

map.zoomControl.setPosition('bottomright');

const d = new Date(); 
d.setDate(d.getDate() - 1);
const dateValue = () => d.toISOString().split('T')[0];

const gibsWMS = "https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi";

/* Panes */
map.createPane('basePane'); 
map.getPane('basePane').style.zIndex = 200;
map.createPane('overlayPane'); 
map.getPane('overlayPane').style.zIndex = 300;
map.createPane('labelPane'); 
map.getPane('labelPane').style.zIndex = 650;
map.getPane('labelPane').style.pointerEvents = 'none';

/* Base layers */
const baseLayers = {
  google_satellite: L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    pane: 'basePane',
    attribution: 'Google Maps Satellite'
  }),
  google_hybrid: L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    pane: 'basePane',
    attribution: 'Google Maps Hybrid'
  }),
  google_streets: L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    pane: 'basePane',
    attribution: 'Google Maps Streets'
  }),
  google_terrain: L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    pane: 'basePane',
    attribution: 'Google Maps Terrain'
  }),
  modis_terra: L.tileLayer.wms(gibsWMS, {
    layers: "MODIS_Terra_CorrectedReflectance_TrueColor",
    format: "image/jpeg",
    time: dateValue(),
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS"
  }),
  modis_aqua: L.tileLayer.wms(gibsWMS, {
    layers: "MODIS_Aqua_CorrectedReflectance_TrueColor",
    format: "image/jpeg",
    time: dateValue(),
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS"
  }),
  viirs: L.tileLayer.wms(gibsWMS, {
    layers: "VIIRS_SNPP_CorrectedReflectance_TrueColor",
    format: "image/jpeg",
    time: dateValue(),
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS"
  }),
  blue_marble: L.tileLayer.wms(gibsWMS, {
    layers: "BlueMarble_ShadedRelief_Bathymetry",
    format: "image/jpeg",
    tileSize: 512,
    pane: 'basePane',
    attribution: "NASA GIBS"
  })
};

let currentBase = baseLayers.google_satellite.addTo(map);

/* Overlay utility */
function createOverlayWMS(layerName, opts = {}) {
  return L.tileLayer.wms(gibsWMS, Object.assign({
    layers: layerName,
    format: 'image/png',
    transparent: true,
    tileSize: 512,
    pane: 'overlayPane',
    attribution: 'NASA GIBS'
  }, opts));
}

/* Overlays */
let aerosolLayer = createOverlayWMS("MODIS_Terra_Aerosol", {opacity: 0.65, time: dateValue()});
let populationLayer = createOverlayWMS("GPW_Population_Density_2020", {opacity: 0.5});
let firesLayer = createOverlayWMS("MODIS_Terra_Fires", {opacity:0.7, time: dateValue()});
let vegetationLayer = createOverlayWMS("MODIS_Terra_CorrectedReflectance_Bands721", {opacity:0.6, time: dateValue()});
let temperatureLayer = createOverlayWMS("MODIS_Terra_Land_Surface_Temp_Day", {opacity:0.6, time: dateValue()});
let featuresLayer = createOverlayWMS("Reference_Features", {opacity:0.85});
let coastlinesLayer = createOverlayWMS("Coastlines", {opacity:0.95});
let labelsLayer = createOverlayWMS("Reference_Labels");

labelsLayer.addTo(map);

/* Health markers */
const healthGroup = L.layerGroup([], {pane:'overlayPane'});
const marker = L.circleMarker([14.7167, -17.4677], { 
  radius:7, 
  color:'#28a745', 
  fillColor:'#28a745', 
  fillOpacity:0.9 
});
marker.bindPopup("<b>Main Hospital of Dakar</b>");
healthGroup.addLayer(marker);

/* OSM overlay */
const osmOverlayGroup = L.layerGroup([], {pane:'overlayPane'});

const cityCoords = {
  "Cotonou":[6.3703, 2.3912],
  "Abidjan":[5.3453, -4.0244],
  "Paris":[48.8566, 2.3522]
};

async function loadOSMCity(city, lat, lon){
  osmOverlayGroup.clearLayers();
  const delta = 0.15;
  const bbox = [lat-delta, lon-delta, lat+delta, lon+delta].join(',');
  
  const queryCities = `[out:json][timeout:25]; node["place"~"city|town"](${bbox}); out body; >; out skel qt;`;
  const urlCities = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(queryCities);
  const respCities = await fetch(urlCities);
  const dataCities = await respCities.json();
  dataCities.elements.forEach(node => {
    const name = node.tags.name || "Unknown";
    const population = node.tags.population ? parseInt(node.tags.population) : 0;
    const radius = population ? Math.sqrt(population)/100 : 4;
    const marker = L.circleMarker([node.lat, node.lon], {
      radius: radius,
      color: '#ff7800',
      fillColor: '#ff7800',
      fillOpacity: 0.6
    }).bindPopup(`<b>${name}</b><br>Population: ${population.toLocaleString()}`);
    osmOverlayGroup.addLayer(marker);
  });
  
  const queryHealth = `[out:json][timeout:25]; node["amenity"~"hospital|clinic"](${bbox}); out body; >; out skel qt;`;
  const urlHealth = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(queryHealth);
  const respHealth = await fetch(urlHealth);
  const dataHealth = await respHealth.json();
  dataHealth.elements.forEach(node => {
    const name = node.tags.name || "Unknown";
    const marker = L.circleMarker([node.lat, node.lon], {
      radius: 6,
      color: '#28a745',
      fillColor: '#28a745',
      fillOpacity: 0.9
    }).bindPopup(`<b>${name}</b>`);
    osmOverlayGroup.addLayer(marker);
  });
}

/* Base layer controls */
document.querySelectorAll('input[name="baseLayer"]').forEach(radio => {
  radio.addEventListener('change', function() {
    map.removeLayer(currentBase);
    currentBase = baseLayers[this.value];
    currentBase.addTo(map);
  });
});

/* Overlay controls */
document.getElementById('chkAerosol').addEventListener('change', e => {
  e.target.checked ? aerosolLayer.addTo(map) : map.removeLayer(aerosolLayer);
});
document.getElementById('chkPopulation').addEventListener('change', e => {
  e.target.checked ? populationLayer.addTo(map) : map.removeLayer(populationLayer);
});
document.getElementById('chkFires').addEventListener('change', e => {
  e.target.checked ? firesLayer.addTo(map) : map.removeLayer(firesLayer);
});
document.getElementById('chkVegetation').addEventListener('change', e => {
  e.target.checked ? vegetationLayer.addTo(map) : map.removeLayer(vegetationLayer);
});
document.getElementById('chkTemperature').addEventListener('change', e => {
  e.target.checked ? temperatureLayer.addTo(map) : map.removeLayer(temperatureLayer);
});
document.getElementById('chkHealth').addEventListener('change', e => {
  e.target.checked ? healthGroup.addTo(map) : map.removeLayer(healthGroup);
});
document.getElementById('chkFeatures').addEventListener('change', e => {
  e.target.checked ? featuresLayer.addTo(map) : map.removeLayer(featuresLayer);
});
document.getElementById('chkCoastlines').addEventListener('change', e => {
  e.target.checked ? coastlinesLayer.addTo(map) : map.removeLayer(coastlinesLayer);
});
document.getElementById('chkLabels').addEventListener('change', e => {
  e.target.checked ? labelsLayer.addTo(map) : map.removeLayer(labelsLayer);
});
document.getElementById('chkOSM').addEventListener('change', e => {
  e.target.checked ? osmOverlayGroup.addTo(map) : map.removeLayer(osmOverlayGroup);
});

/* EONET Events */
const eventsGroup = L.layerGroup().addTo(map);
async function loadEvents() {
  try {
    const resp = await fetch("https://eonet.gsfc.nasa.gov/api/v3/events?status=open&limit=50");
    const data = await resp.json();
    const ul = document.getElementById("eventList"); 
    ul.innerHTML = "";
    data.events.forEach(ev => {
      const geom = ev.geometry?.[0]; 
      if(!geom) return;
      const coords = geom.coordinates; 
      let icon = "üåç";
      ev.categories.forEach(cat=>{
        const c = cat.title.toLowerCase();
        if(c.includes("wildfire")) icon="üî•";
        if(c.includes("storm")||c.includes("cyclone")||c.includes("hurricane")) icon="üå™Ô∏è";
        if(c.includes("volcano")) icon="üåã";
        if(c.includes("flood")) icon="üíß";
      });
      const li = document.createElement("li");
      li.innerHTML = `${icon} <strong>${ev.title}</strong><small>${geom.date}</small>`;
      li.addEventListener("click", ()=> {
        map.setView([coords[1], coords[0]],6);
        const marker = L.marker([coords[1], coords[0]], {
          icon:L.divIcon({
            className:"event-icon", 
            html:`<div style="font-size:30px;">${icon}</div>`, 
            iconSize:[30,30], 
            iconAnchor:[15,15]
          })
        }).bindPopup(`<b>${ev.title}</b><br>${geom.date}<br><a href="${ev.sources?.[0]?.url||'#'}" target="_blank">üîó More info</a>`);
        eventsGroup.addLayer(marker);
      });
      ul.appendChild(li);
    });
  } catch(err){ 
    console.error(err); 
  }
}
loadEvents();

/* City selector */
document.getElementById("citySelector").addEventListener("change", function(){
  const city = this.value;
  if(cityCoords[city]){
    const [lat, lon] = cityCoords[city];
    map.setView([lat, lon], 12);
    loadOSMCity(city, lat, lon);
  } else {
    osmOverlayGroup.clearLayers();
  }
});
</script>
</body>
</html>